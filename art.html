<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ethereal Particle Flow Field</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #000;
        }

        canvas {
            display: block;
        }
    </style>
</head>

<body>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>

    <script>
        // =====================================================
        // ETHEREAL PARTICLE FLOW FIELD â€“ FIXED VERSION
        // =====================================================

        let particles = [];
        const numParticles = 1500;

        let zOff = 0;
        const noiseScale = 0.005;
        const zSpeed = 0.002;

        function setup() {
            createCanvas(windowWidth, windowHeight);
            blendMode(ADD);
            colorMode(HSB, 360, 100, 100, 100);

            for (let i = 0; i < numParticles; i++) {
                particles.push(new Particle());
            }
            background(0);
        }

        function draw() {
            // Fade for glowing trails
            fill(0, 5);
            noStroke();
            rect(0, 0, width, height);

            // Evolve the 3D noise field
            zOff += zSpeed;

            for (let p of particles) {
                p.update(zOff);
                p.display();
            }
        }

        class Particle {
            constructor() {
                this.pos = createVector(random(width), random(height));
                this.vel = createVector(0, 0);
                this.acc = createVector(0, 0);
                this.size = random(1, 4);
                this.maxSpeed = 3;
                this.forceMult = 0.15;
                this.hue = random(360);
                this.hueSpeed = random(0.5, 2);
                this.concentrationHue = random(360);
            }

            update(zOffset) {
                // ---- Multi-octave 3D Perlin flow field ----
                let xOff = this.pos.x * noiseScale;
                let yOff = this.pos.y * noiseScale;

                let angle = noise(xOff, yOff, zOffset) * TWO_PI * 2;
                let angle2 = noise(xOff * 2, yOff * 2, zOffset + 1000) * TWO_PI * 2;
                let fieldForce = p5.Vector.fromAngle(angle + 0.5 * angle2);
                fieldForce.mult(this.forceMult);
                this.acc.add(fieldForce);

                // ---- Mouse attraction (inverse distance) ----
                if (mouseX >= 0 && mouseY >= 0) {
                    let mouse = createVector(mouseX, mouseY);
                    let dir = p5.Vector.sub(mouse, this.pos);
                    let d = dir.mag();
                    if (d < 400) {                     // reasonable influence radius
                        dir.normalize();
                        let strength = 0.5 / (d * 0.01 + 1);  // increased strength
                        dir.mult(strength);
                        this.acc.add(dir);
                    }
                }

                // ---- Physics ----
                this.vel.add(this.acc);
                this.vel.limit(this.maxSpeed);
                this.pos.add(this.vel);
                this.acc.mult(0);

                this.edges();
            }

            display() {
                // Update individual particle hue
                this.hue = (this.hue + this.hueSpeed) % 360;

                // Check for nearby particles (concentration)
                let nearbyCount = 0;
                for (let other of particles) {
                    if (other !== this) {
                        let d = p5.Vector.dist(this.pos, other.pos);
                        if (d < 30) {  // Concentration threshold
                            nearbyCount++;
                        }
                    }
                }

                let finalHue, sat, val;

                if (nearbyCount > 3) {  // If concentrated, use random color
                    finalHue = this.concentrationHue;
                    sat = random(70, 95);
                    val = random(60, 90);
                } else {  // Normal color
                    finalHue = this.hue;
                    sat = random(60, 90);
                    val = random(50, 85);
                }

                fill(finalHue, sat, val, 8);
                noStroke();
                circle(this.pos.x, this.pos.y, this.size);
            }

            edges() {
                if (this.pos.x > width) this.pos.x = 0;
                if (this.pos.x < 0) this.pos.x = width;
                if (this.pos.y > height) this.pos.y = 0;
                if (this.pos.y < 0) this.pos.y = height;
            }
        }

        function windowResized() {
            resizeCanvas(windowWidth, windowHeight);
            background(0);
        }
    </script>
</body>

</html>